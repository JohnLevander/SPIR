##
## Avian Flu Plots
##
## Author......: Luis Gustavo Nardin
## Last Change.: 04/13/2016
##
library(data.table)
library(deSolve)
library(ggplot2)
library(grid)
library(gridExtra)
library(gtable)

setwd("/data/workspace/cmci/SPIR/scripts/")

baseDir <- "/data/projects/current/cmci/project-3/sub-projects/spir/"
inputFluavianDir <- paste0(baseDir, "fluavian/")
outputDir <- paste0(baseDir, "figures/")

###############
## FUNCTIONS
###############
source("calcSwitch.R")
source("calcUtilities.R")
source("SPIRmodel.R")


###############
## AVIAN FLU INPUT PARAMETERS
###############
# Disease duration
duration <- 8

# R0
R0 <- 2

# gamma
gamma <- 1 / duration

# beta
betaS <- R0 / duration

# Infection probability (Susceptible)
bs <- 1 - exp(-betaS)

# Prophylactic protection
rho <- 0.01

# Recover probability
g <- 1 - exp(-gamma)

# Discount factor (0 = No discount)
lambda <- 0

# Fear factor (1 = No fear)
kappa <- 1

# Decision frequency
delta <- 0

# Planning horizon
h <- 30


# Payoffs (S, P, I, R)
payoffs <- c(1, 0.95, 0.60, 1)

# Initial values
yinit <- c(S = 100000 - 1, P = 0, I = 1, R = 0)

# Length of simulation
times <- seq(1, 250, 1)


###############
## HEAT MAP
###############
filename <- "fluavian-1"
data <- data.table(read.table(paste0(inputFluavianDir, filename,".csv"),
                              sep=";", header=TRUE))

maxh <- 365
pData <- data[which((h <= maxh))]

pl <- ggplot(pData[which((n == 0) & (i < 1))],
             aes(x=h, y=(1 - rho) * 100, fill=(i * 100))) +
  xlab(expression(paste("Planning Horizon (H)"))) +
  ylab(expression(paste("% Protection (1 - ", rho, ")"))) +
  xlim(0, maxh + 20) +
  geom_raster(interpolate=TRUE, stat="identity") +
  geom_contour(data=pData[which(n == 2)],
               aes(x=h, y=(1 - rho) * 100, z=pI),
               breaks=c(0.3, 0.5, 0.7, 0.9),
               color="black",
               linetype="solid",
               size=0.5) +
  geom_line(data=pData[which(n == 2)],
            alpha=0.05,
            size=1) +
  geom_segment(aes(x = 40, y = 77, xend = 50, yend = 75),
               color="black", show.legend=FALSE) +
  annotate("text", x=150, y=50, label="A", fontface="italic", size=7) +
  annotate("text", x=25, y=90, label="B", fontface="italic", size=7) +
  annotate("text", x=55, y=75, label="C", fontface="italic", size=7) +
  scale_y_continuous(limits=c(0, 100),
                     breaks=c(0, 25, 50, 75, 100),
                     labels=c("0%", "25%", "50%", "75%", "100%")) +
  scale_fill_gradientn(name = expression(paste("% Infective (i)")),
                       limits = c(0, 100),
                       values = c(0.0, 0.05, 0.1, 0.2, 0.3, 0.5, 0.7, 1.0),
                       colours = c("red", "yellow", "green", "blue"),
                       labels = c("0%", "25%", "50%", "75%", "100%")) +
  theme(axis.title.x = element_text(colour='black', size=14, face='bold',
                                    margin=margin(t=0.2, unit = "cm")),
        axis.title.y = element_text(colour='black', size=16, face='bold',
                                    margin=margin(r=0.5, unit = "cm")),
        axis.text.x = element_text(colour='black', size=16, face='bold'),
        axis.text.y = element_text(colour='black', size=16, face='bold'),
        axis.line = element_line(colour='black', size=1, linetype='solid'),
        panel.background = element_rect(fill="transparent", colour=NA),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin = unit(c(0.5, 0, 0.5, 0), "cm"),
        #legend.position = "none",
        legend.title = element_text(colour="black", size=14, face="bold"),
        legend.text = element_text(colour="black", size=12, face="bold"),
        legend.key = element_rect(fill = "white"))

pl <- pl + annotation_custom(
  grob = textGrob(label = "D", hjust = 0,
                  gp = gpar(cex = 1.3, fontface="bold")),
  ymin = 108,
  ymax = 108,
  xmin = -77,
  xmax = -77)

gt <- ggplot_gtable(ggplot_build(pl))
gt$layout$clip[gt$layout$name == "panel"] <- "off"


###############
## NO SWITCHING
###############
rho <- 0.5
h <- 3

data <- data.table(calc_utilities(h, bs, rho, g, lambda, kappa, payoffs))

data$state <- factor(data$state, levels=rev(levels(as.factor(data$state))))

ymax <- max(as.numeric(as.character(data[which(i > 0)]$U)))

pu1 <- ggplot(data[which(i > 0)], aes(x=as.numeric(as.character(i)) * 100,
                                      y=as.numeric(as.character(U)),
                                      group=state,
                                      color=state,
                                      linetype=state)) +
  xlab("") + ylab(expression(paste("Utility"))) +
  geom_line(size=0.9) +
  scale_x_continuous(breaks=c(0, 50, 100),
                     labels=c("0%", "50%", "100%"),
                     limits=c(0, 110)) +
  scale_linetype_manual(name="",
                        values=c("solid", "dashed"),
                        labels=c("Susceptible", "Prophylactic")) +
  scale_color_manual(name="",
                     values=c("black", "black"),
                     labels=c("Susceptible", "Prophylactic")) +
  theme(axis.title.x = element_text(colour = 'black', size = 12, face = 'bold',
                                    margin=margin(t=0.2, unit = "cm")),
        axis.title.y = element_text(colour = 'black', size = 16, face = 'bold',
                                    margin=margin(r=0.4, unit = "cm")),
        axis.text.x = element_text(colour = 'black', size = 12, face = 'bold'),
        axis.text.y = element_blank(),
        axis.line = element_line(colour = 'black', size = 1.5, linetype = 'solid'),
        panel.background = element_rect(fill = "transparent", colour = NA),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin = unit(c(0.5, 0, 0.5, 0), "cm"),
        legend.position = "none",
        legend.title = element_text(colour="black", size=14, face="bold"),
        legend.text = element_text(colour="black", size=12, face="bold"),
        legend.key = element_rect(fill = "white"))

pu1 <- pu1 + annotation_custom(
  grob = textGrob(label = "A", hjust = 0,
                  gp = gpar(cex = 1.3, fontface="bold")),
  ymin = ymax+0.02,
  ymax = ymax+0.02,
  xmin = -25,
  xmax = -25)

gt1 <- ggplot_gtable(ggplot_build(pu1))
gt1$layout$clip[gt1$layout$name == "panel"] <- "off"


###############
## ONE SWITCHING POINT
###############
rho <- 0.5
h <- 10

data <- data.table(calc_utilities(h, bs, rho, g, lambda, kappa, payoffs))

data$state <- factor(data$state, levels=rev(levels(as.factor(data$state))))

ymax <- max(as.numeric(as.character(data[which(i > 0)]$U)))

pu2 <- ggplot(data[which(i > 0)], aes(x=as.numeric(as.character(i)) * 100,
                                      y=as.numeric(as.character(U)),
                                      group=state,
                                      color=state,
                                      linetype=state)) +
  xlab(expression(paste("% Infective"))) + ylab("") +
  geom_line(size=0.9) +
  scale_x_continuous(breaks=c(0, 50, 100),
                     labels=c("0%", "50%", "100%"),
                     limits=c(0, 110)) +
  scale_linetype_manual(name="",
                        values=c("solid", "dashed"),
                        labels=c("Susceptible", "Prophylactic")) +
  scale_color_manual(name="",
                     values=c("black", "black"),
                     labels=c("Susceptible", "Prophylactic")) +
  theme(axis.title.x = element_text(colour = 'black', size = 14, face = 'bold',
                                    margin=margin(t=0.2, unit = "cm")),
        axis.title.y = element_text(colour = 'black', size = 16, face = 'bold',
                                    margin=margin(r=0.4, unit = "cm")),
        axis.text.x = element_text(colour = 'black', size = 12, face = 'bold'),
        axis.text.y = element_blank(),
        axis.line = element_line(colour = 'black', size = 1.5, linetype = 'solid'),
        panel.background = element_rect(fill = "transparent", colour = NA),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin = unit(c(0.5, 0, 0.5, 0), "cm"),
        legend.position = "none",
        legend.title = element_text(colour="black", size=14, face="bold"),
        legend.text = element_text(colour="black", size=12, face="bold"),
        legend.key = element_rect(fill = "white"))

pu2 <- pu2 + annotation_custom(
  grob = textGrob(label = "B", hjust = 0,
                  gp = gpar(cex = 1.3, fontface="bold")),
  ymin = ymax+0.05,
  ymax = ymax+0.05,
  xmin = -26,
  xmax = -26)

gt2 <- ggplot_gtable(ggplot_build(pu2))
gt2$layout$clip[gt2$layout$name == "panel"] <- "off"

###############
## TWO SWITCHING POINTS
###############
rho <- 0.25
h <- 40

data <- data.table(calc_utilities(h, bs, rho, g, lambda, kappa, payoffs))

data$state <- factor(data$state, levels=rev(levels(as.factor(data$state))))

ymax <- max(as.numeric(as.character(data[which(i > 0)]$U)))

pu3 <- ggplot(data[which(i > 0)], aes(x=as.numeric(as.character(i)) * 100,
                                      y=as.numeric(as.character(U)),
                                      group=state,
                                      color=state,
                                      linetype=state)) +
  xlab("") + ylab("") +
  geom_line(size=0.9) +
  scale_x_continuous(breaks=c(0, 50, 100),
                     labels=c("0%", "50%", "100%"),
                     limits=c(0, 110)) +
  scale_linetype_manual(name="",
                        values=c("dashed", "solid"),
                        labels=c(expression(paste("Susceptible")),
                                 expression(paste("Prophylactic")))) +
  scale_color_manual(name="",
                     values=c("black", "black"),
                     labels=c(expression(paste("Susceptible")),
                              expression(paste("Prophylactic")))) +
  theme(axis.title.x = element_text(colour = 'black', size = 12, face = 'bold',
                                    margin=margin(t=0.2, unit = "cm")),
        axis.title.y = element_text(colour = 'black', size = 12, face = 'bold',
                                    margin=margin(r=0.4, unit = "cm")),
        axis.text.x = element_text(colour = 'black', size = 12, face = 'bold'),
        axis.text.y = element_blank(),
        axis.line = element_line(colour = 'black', size = 1.5, linetype = 'solid'),
        panel.background = element_rect(fill = "transparent", colour = NA),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin = unit(c(0.5, 0, 0.5, 0), "cm"),
        #legend.position = "none",
        legend.title = element_text(colour="black", size=14, face="bold"),
        legend.text = element_text(colour="black", size=12, face="bold"),
        legend.key = element_rect(fill = "white"))

pu3 <- pu3 + annotation_custom(
  grob = textGrob(label = "C", hjust = 0,
                  gp = gpar(cex = 1.3, fontface="bold")),
  ymin = ymax+0.1,
  ymax = ymax+0.1,
  xmin = -26,
  xmax = -26)

gt3 <- ggplot_gtable(ggplot_build(pu3))
gt3$layout$clip[gt3$layout$name == "panel"] <- "off"

plot <- grid.arrange(gt1, gt2, gt3, gt, ncol=3, nrow=2,
                     layout_matrix= rbind(c(1,2,3),
                                          c(4,4,4)),
                     heights=c(1.5,3), widths=c(0.65,0.65,1))

ggsave(paste0(outputDir, "fluavian-heat.pdf"), plot=plot)


###############
## CASE 1
###############
filename <- "fluavian-1"
data <- data.table(read.table(paste0(inputFluavianDir, filename,".csv"),
                              sep=";", header=TRUE))

maxh <- 365
pData <- data[which((h <= maxh))]

pc1 <- ggplot(pData[which((n == 0) & (i < 1))],
              aes(x=h, y=(1 - rho) * 100, fill=(i * 100))) +
  xlab(expression(paste("u"[S]*" = u"[R]*" > u"[P]))) +
  ylab(expression(paste("% Protection (1 - ", rho, ")"))) +
  xlim(0, maxh + 30) +
  geom_raster(interpolate=TRUE, stat="identity") +
  geom_contour(data=pData[which(n == 2)],
               aes(x=h, y=(1 - rho) * 100, z=pI),
               breaks=c(0.3, 0.5, 0.7, 0.9),
               color="black",
               linetype="solid",
               size=0.5) +
  geom_line(data=pData[which(n == 2)],
            alpha=0.05,
            size=1) +
  scale_y_continuous(limits=c(0, 100),
                     breaks=c(0, 25, 50, 75, 100),
                     labels=c("0%", "25%", "50%", "75%", "100%")) +
  scale_fill_gradientn(name = expression(paste("% Infective (i)")),
                       limits = c(0, 100),
                       values = c(0.0, 0.05, 0.1, 0.2, 0.3, 0.5, 0.7, 1.0),
                       colours = c("red", "yellow", "green", "blue"),
                       labels = c("0%", "25%", "50%", "75%", "100%")) +
  theme(axis.title.x = element_text(colour='black', size=38, face='bold',
                                    margin=margin(t=0.5, unit = "cm")),
        axis.title.y = element_text(colour='black', size=28, face='bold',
                                    margin=margin(r=1.2, unit = "cm")),
        axis.text.x = element_text(colour='black', size=16, face='bold'),
        axis.text.y = element_text(colour='black', size=16, face='bold'),
        axis.line = element_line(colour='black', size=1, linetype='solid'),
        panel.background = element_rect(fill="transparent", colour=NA),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin = unit(c(1, 0, 0, 0), "cm"),
        legend.position = "none",
        legend.title = element_text(colour="black", size=14, face="bold"),
        legend.text = element_text(colour="black", size=12, face="bold"),
        legend.key = element_rect(fill = "white"))

pc1 <- pc1 + annotation_custom(
  grob = textGrob(label = "A", hjust = 0,
                  gp = gpar(cex = 3.5, fontface="bold")),
  ymin = 107,
  ymax = 107,
  xmin = -120,
  xmax = -120)

gtc1 <- ggplot_gtable(ggplot_build(pc1))
gtc1$layout$clip[gtc1$layout$name == "panel"] <- "off"


###############
## CASE 2
###############
filename <- "fluavian-0.97"
data <- data.table(read.table(paste0(inputFluavianDir, filename,".csv"),
                              sep=";", header=TRUE))

maxh <- 365
pData <- data[which((h <= maxh))]

pc2 <- ggplot(pData[which((n == 0) & (i < 1))],
              aes(x=h, y=(1 - rho) * 100, fill=(i * 100))) +
  xlab(expression(paste("u"[S]*" > u"[R]*" > u"[P]))) +
  ylab("") +
  xlim(0, maxh + 30) +
  geom_raster(interpolate=TRUE, stat="identity") +
  geom_contour(data=pData[which(n == 2)],
               aes(x=h, y=(1 - rho) * 100, z=pI),
               breaks=c(0.3, 0.5, 0.7, 0.9),
               color="black",
               linetype="solid",
               size=0.5) +
  geom_line(data=pData[which(n == 2)],
            alpha=0.05,
            size=1) +
  scale_y_continuous(limits=c(0, 100),
                     breaks=c(0, 25, 50, 75, 100),
                     labels=c("0%", "25%", "50%", "75%", "100%")) +
  scale_fill_gradientn(name = expression(paste("% Infective (i)")),
                       limits = c(0, 100),
                       values = c(0.0, 0.05, 0.1, 0.2, 0.3, 0.5, 0.7, 1.0),
                       colours = c("red", "yellow", "green", "blue"),
                       labels = c("0%", "25%", "50%", "75%", "100%")) +
  theme(axis.title.x = element_text(colour='black', size=38, face='bold',
                                    margin=margin(t=0.5, unit = "cm")),
        axis.title.y = element_text(colour='black', size=28, face='bold',
                                    margin=margin(r=1.2, unit = "cm")),
        axis.text.x = element_text(colour='black', size=16, face='bold'),
        axis.text.y = element_text(colour='black', size=16, face='bold'),
        axis.line = element_line(colour='black', size=1, linetype='solid'),
        panel.background = element_rect(fill="transparent", colour=NA),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin = unit(c(1, 0, 0, 0), "cm"),
        legend.position = "none",
        legend.title = element_text(colour="black", size=14, face="bold"),
        legend.text = element_text(colour="black", size=12, face="bold"),
        legend.key = element_rect(fill = "white"))

pc2 <- pc2 + annotation_custom(
  grob = textGrob(label = "B", hjust = 0,
                  gp = gpar(cex = 3.5, fontface="bold")),
  ymin = 107,
  ymax = 107,
  xmin = -120,
  xmax = -120)

gtc2 <- ggplot_gtable(ggplot_build(pc2))
gtc2$layout$clip[gtc2$layout$name == "panel"] <- "off"


###############
## CASE 3
###############
filename <- "fluavian-0.95"
data <- data.table(read.table(paste0(inputFluavianDir, filename,".csv"),
                              sep=";", header=TRUE))

maxh <- 365
pData <- data[which((h <= maxh))]

pc3 <- ggplot(pData[which((n == 0) & (i < 1))],
              aes(x=h, y=(1 - rho) * 100, fill=(i * 100))) +
  xlab(expression(paste("u"[S]*" > u"[R]*" = u"[P]))) +
  ylab("") +
  xlim(0, maxh + 30) +
  geom_raster(interpolate=TRUE, stat="identity") +
  geom_contour(data=pData[which(n == 2)],
               aes(x=h, y=(1 - rho) * 100, z=pI),
               breaks=c(0.3, 0.5, 0.7, 0.9),
               color="black",
               linetype="solid",
               size=0.5) +
  geom_line(data=pData[which(n == 2)],
            alpha=0.05,
            size=1) +
  scale_y_continuous(limits=c(0, 100),
                     breaks=c(0, 25, 50, 75, 100),
                     labels=c("0%", "25%", "50%", "75%", "100%")) +
  scale_fill_gradientn(name = expression(paste("% Infective (i)")),
                       limits = c(0, 100),
                       values = c(0.0, 0.05, 0.1, 0.2, 0.3, 0.5, 0.7, 1.0),
                       colours = c("red", "yellow", "green", "blue"),
                       labels = c("0%", "25%", "50%", "75%", "100%")) +
  theme(axis.title.x = element_text(colour='black', size=38, face='bold',
                                    margin=margin(t=0.5, unit = "cm")),
        axis.title.y = element_text(colour='black', size=28, face='bold',
                                    margin=margin(r=1.2, unit = "cm")),
        axis.text.x = element_text(colour='black', size=16, face='bold'),
        axis.text.y = element_text(colour='black', size=16, face='bold'),
        axis.line = element_line(colour='black', size=1, linetype='solid'),
        panel.background = element_rect(fill="transparent", colour=NA),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin = unit(c(1, 0, 0, 0), "cm"),
        legend.position = "none",
        legend.title = element_text(colour="black", size=14, face="bold"),
        legend.text = element_text(colour="black", size=12, face="bold"),
        legend.key = element_rect(fill = "white"))

pc3 <- pc3 + annotation_custom(
  grob = textGrob(label = "C", hjust = 0,
                  gp = gpar(cex = 3.5, fontface="bold")),
  ymin = 107,
  ymax = 107,
  xmin = -120,
  xmax = -120)

gtc3 <- ggplot_gtable(ggplot_build(pc3))
gtc3$layout$clip[gtc3$layout$name == "panel"] <- "off"


###############
## CASE 4
###############
filename <- "fluavian-0.9"
data <- data.table(read.table(paste0(inputFluavianDir, filename,".csv"),
                              sep=";", header=TRUE))

maxh <- 365
pData <- data[which((h <= maxh))]

pc4 <- ggplot(pData[which((n == 0) & (i < 1))],
              aes(x=h, y=(1 - rho) * 100, fill=(i * 100))) +
  xlab(expression(paste("u"[S]*" > u"[P]*" > u"[R]))) +
  ylab("") +
  xlim(0, maxh + 30) +
  geom_raster(interpolate=TRUE, stat="identity") +
  geom_contour(data=pData[which(n == 2)],
               aes(x=h, y=(1 - rho) * 100, z=pI),
               breaks=c(0.3, 0.5, 0.7, 0.9),
               color="black",
               linetype="solid",
               size=0.5) +
  geom_line(data=pData[which(n == 2)],
            alpha=0.05,
            size=1) +
  scale_y_continuous(limits=c(0, 100),
                     breaks=c(0, 25, 50, 75, 100),
                     labels=c("0%", "25%", "50%", "75%", "100%")) +
  scale_fill_gradientn(name = expression(paste("% Infective (i)")),
                       limits = c(0, 100),
                       values = c(0.0, 0.05, 0.1, 0.2, 0.3, 0.5, 0.7, 1.0),
                       colours = c("red", "yellow", "green", "blue"),
                       labels = c("0%", "25%", "50%", "75%", "100%")) +
  theme(axis.title.x = element_text(colour='black', size=38, face='bold',
                                    margin=margin(t=0.5, unit = "cm")),
        axis.title.y = element_text(colour='black', size=28, face='bold',
                                    margin=margin(r=1.2, unit = "cm")),
        axis.text.x = element_text(colour='black', size=16, face='bold'),
        axis.text.y = element_text(colour='black', size=16, face='bold'),
        axis.line = element_line(colour='black', size=1, linetype='solid'),
        panel.background = element_rect(fill="transparent", colour=NA),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin = unit(c(1, 0, 0, 0), "cm"),
        legend.position = "none",
        legend.title = element_text(colour="black", size=14, face="bold"),
        legend.text = element_text(colour="black", size=12, face="bold"),
        legend.key = element_rect(fill = "white"))

pc4 <- pc4 + annotation_custom(
  grob = textGrob(label = "D", hjust = 0,
                  gp = gpar(cex = 3.5, fontface="bold")),
  ymin = 107,
  ymax = 107,
  xmin = -120,
  xmax = -120)

gtc4 <- ggplot_gtable(ggplot_build(pc4))
gtc4$layout$clip[gtc4$layout$name == "panel"] <- "off"

plot <- grid.arrange(gtc1, gtc2, gtc3, gtc4, ncol=4, nrow=1,
                     layout_matrix= rbind(c(1, 2, 3, 4)),
                     heights=c(0.25), widths=c(0.25,0.25,0.25,0.25),
                     bottom=textGrob(expression(paste("Planning Horizon (H)")),
                                     gp=gpar(fontsize=34,
                                             fontface="bold")))

ggsave(paste0(outputDir,"fluavian-cases.pdf"), plot=plot,
       width=80, height=15, units="cm")


###############
## DYNAMICS PLANNING HORIZON
###############
times <- seq(1, 250, 1)
rho <-0.1
h <- 3
delta <- 0.01
iswitch <- calc_iswitch(h, bs, rho, g, lambda, kappa, payoffs)
pars <- list(R0, duration, gamma, betaS, delta, iswitch)
out <- as.data.frame(lsoda(yinit, times, SPIRmodel, pars, rtol=1e-3, atol=1e-3))
data <- data.table(H=h, time=out$time, S=out$S, P=out$P, I=out$I, R=out$R)

h <- 15
delta <- 0.01
iswitch <- calc_iswitch(h, bs, rho, g, lambda, kappa, payoffs)
pars <- list(R0, duration, gamma, betaS, delta, iswitch)
out <- as.data.frame(lsoda(yinit, times, SPIRmodel, pars, rtol=1e-3, atol=1e-3))
data <- rbind(data, data.table(H=h, time=out$time, S=out$S, P=out$P, I=out$I, R=out$R))
isp <- data.table(H=h, i=iswitch[iswitch[,8] != 1,8])

h <- 30
delta <- 0.01
iswitch <- calc_iswitch(h, bs, rho, g, lambda, kappa, payoffs)
pars <- list(R0, duration, gamma, betaS, delta, iswitch)
out <- as.data.frame(lsoda(yinit, times, SPIRmodel, pars, rtol=1e-3, atol=1e-3))
data <- rbind(data, data.table(H=h, time=out$time, S=out$S, P=out$P, I=out$I, R=out$R))
isp <- rbind(isp, data.table(H=h, i=iswitch[iswitch[,8] != 1,8]))

h <- 90
delta <- 0.01
iswitch <- calc_iswitch(h, bs, rho, g, lambda, kappa, payoffs)
pars <- list(R0, duration, gamma, betaS, delta, iswitch)
out <- as.data.frame(lsoda(yinit, times, SPIRmodel, pars, rtol=1e-3, atol=1e-3))
data <- rbind(data, data.table(H=h, time=out$time, S=out$S, P=out$P, I=out$I, R=out$R))
isp <- rbind(isp, data.table(H=h, i=iswitch[iswitch[,8] != 1,8]))

pl <- ggplot(data, aes(x=time, y=((I / (S+P+I+R)) * 100),
                       colour=as.factor(H),
                       size=as.factor(H))) +
  xlab("") + ylab("") +
  geom_line() +
  scale_colour_manual(name=expression(paste("Planning\nHorizon (H)")),
                      values=c("grey60", "blue", "red", "green")) +
  scale_size_manual(name=expression(paste("Planning\nHorizon (H)")),
                    values=c(15, 10, 5, 2)) +
  scale_y_continuous(limits=c(0, 35),
                     breaks=c(0, 5, 10, 15),
                     labels=c("0%", "5%", "10%", "15%")) +
  guides(colour=guide_legend(override.aes=list(size=2))) +
  theme(axis.title.x = element_text(colour='black', size=12, face='bold',
                                    margin=margin(t=0.5, unit = "cm")),
        axis.title.y = element_text(colour='black', size=48, face='bold',
                                    margin=margin(r=0.5, unit = "cm")),
        axis.text.x = element_text(colour='black', size=24, face='bold'),
        axis.text.y = element_text(colour='black', size=24, face='bold'),
        axis.line = element_line(colour='black', size=1.5, linetype='solid'),
        panel.background = element_rect(fill = "transparent",colour = NA),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin = unit(c(1, 0, 0, 0), "cm"),
        #legend.position = "none",
        legend.title = element_text(colour="black", size=34, face="bold"),
        legend.text = element_text(colour="black", size=28, face="bold"),
        legend.key = element_rect(fill = "white"),
        legend.key.height=unit(1.5,"line"))

if(nrow(isp) > 0){
  pl <- pl + geom_hline(data=isp, aes(yintercept=i*100),
                        linetype="dashed", color=c("blue","red"), size=1)
}

pl <- pl + annotation_custom(
  grob = textGrob(label = "B", hjust = 0,
                  gp = gpar(cex = 4, fontface="bold")),
  ymin = 35,
  ymax = 35,
  xmin = -47,
  xmax = -47)

gth2 <- ggplot_gtable(ggplot_build(pl))
gth2$layout$clip[gth2$layout$name == "panel"] <- "off"

plot <- grid.arrange(gth1, gth2, ncol=2, nrow=1,
                    layout_matrix= rbind(c(1, 2)),
                    heights=c(1), widths=c(0.5, 0.5),
                    bottom=textGrob(expression(paste("Time (t)")),
                                    gp=gpar(fontsize=48,
                                            fontface="bold")))

ggsave(paste0(outputDir,"planning-horizon.pdf"), plot=plot,
       width=80, height=25, units="cm")


###############
## DYNAMICS DECISION
###############
times <- seq(1, 250, 1)
rho <- 0.1
h <- 30
delta <- 0
iswitch <- calc_iswitch(h, bs, rho, g, lambda, kappa, payoffs)
pars <- list(R0, duration, gamma, betaS, delta, iswitch)
out <- as.data.frame(lsoda(yinit, times, SPIRmodel, pars, rtol=1e-3, atol=1e-3))
data <- data.table(D=delta, time=out$time, S=out$S, P=out$P, I=out$I, R=out$R)
isp <- data.table(i=iswitch[iswitch[,8] != 1,8])

h <- 30
delta <- 0.01
iswitch <- calc_iswitch(h, bs, rho, g, lambda, kappa, payoffs)
pars <- list(R0, duration, gamma, betaS, delta, iswitch)
out <- as.data.frame(lsoda(yinit, times, SPIRmodel, pars, rtol=1e-3, atol=1e-3))
data <- rbind(data, data.table(D=delta, time=out$time, S=out$S, P=out$P, I=out$I, R=out$R))
isp <- data.table(i=iswitch[iswitch[,8] != 1,8])

h <- 30
delta <- 0.10
iswitch <- calc_iswitch(h, bs, rho, g, lambda, kappa, payoffs)
pars <- list(R0, duration, gamma, betaS, delta, iswitch)
out <- as.data.frame(lsoda(yinit, times, SPIRmodel, pars, rtol=1e-3, atol=1e-3))
data <- rbind(data, data.table(D=delta, time=out$time, S=out$S, P=out$P, I=out$I, R=out$R))
isp <- rbind(isp, data.table(i=iswitch[iswitch[,8] != 1,8]))


pl <- ggplot(data, aes(x=time, y=((I / (S+P+I+R)) * 100),
                       colour=as.factor(D),
                       size=as.factor(D))) +
  xlab("") + ylab("") +
  geom_line() +
  scale_colour_manual(name=expression(paste("Decision\nFrequency (d)")),
                      values=c("grey60", "blue", "red"),
                      labels=c("0.00", "0.01", "0.02")) +
  scale_size_manual(name=expression(paste("Decision\nFrequency (d)")),
                    values=c(15, 10, 5),
                    labels=c("0.00", "0.01", "0.02")) +
  scale_y_continuous(limits=c(0, 17),
                     breaks=c(0, 5, 10, 15),
                     labels=c("0%", "5%", "10%", "15%")) +
  guides(colour = guide_legend(override.aes=list(size=2))) +
  theme(axis.title.x = element_text(colour='black', size=12, face='bold',
                                    margin=margin(t=0.5, unit = "cm")),
        axis.title.y = element_text(colour='black', size=48, face='bold',
                                    margin=margin(r=0.5, unit = "cm")),
        axis.text.x = element_text(colour='black', size=24, face='bold'),
        axis.text.y = element_text(colour='black', size=24, face='bold'),
        axis.line = element_line(colour='black', size=1.5, linetype='solid'),
        panel.background = element_rect(fill = "transparent",colour = NA),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin = unit(c(1, 0, 0, 0), "cm"),
        #legend.position = "none",
        legend.title = element_text(colour="black", size=34, face="bold"),
        legend.text = element_text(colour="black", size=28, face="bold"),
        legend.key = element_rect(fill = "white"),
        legend.key.height=unit(1.5,"line"))

if(nrow(isp) > 0){
  pl <- pl + geom_hline(data=isp, aes(yintercept=i*100),
                        linetype="dashed", color=c("black","black"), size=1)
}

pl <- pl + annotation_custom(
  grob = textGrob(label = "B", hjust = 0,
                  gp = gpar(cex = 4, fontface="bold")),
  ymin = 18,
  ymax = 18,
  xmin = -47,
  xmax = -47)

gtd2 <- ggplot_gtable(ggplot_build(pl))
gtd2$layout$clip[gtd2$layout$name == "panel"] <- "off"

#ggsave(paste0(outputDir,"fluavian-decision.pdf"), plot=gt)

plot <- grid.arrange(gtd1, gtd2, ncol=2, nrow=1,
                     layout_matrix= rbind(c(1, 2)),
                     heights=c(1), widths=c(0.5, 0.5),
                     bottom=textGrob(expression(paste("Time (t)")),
                                     gp=gpar(fontsize=48,
                                             fontface="bold")))

ggsave(paste0(outputDir,"decision.pdf"), plot=plot,
       width=80, height=25, units="cm")


###############
## FEAR
###############
filename <- "fluavian-1"
data <- data.table(read.table(paste0(inputFluavianDir, filename,".csv"),
                              sep=";", header=TRUE))

maxh <- 365
pData <- data[which((h <= maxh))]

pf1 <- ggplot(pData[which((n == 0) & (i < 1))],
              aes(x=h, y=(1 - rho) * 100, fill=(i * 100))) +
  xlab("") +
  ylab(expression(paste("% Protection (1 - ", rho, ")"))) +
  xlim(0, maxh + 60) +
  geom_raster(interpolate=TRUE, stat="identity") +
  geom_contour(data=pData[which(n == 2)],
               aes(x=h, y=(1 - rho) * 100, z=pI),
               breaks=c(0.3, 0.5, 0.7, 0.9),
               color="black",
               linetype="solid",
               size=0.5) +
  geom_line(data=pData[which(n == 2)],
            alpha=0.05,
            size=1) +
  annotate("text", x=190, y=65, label="kappa == 1.0", fontface="bold", size=7, parse=TRUE) +
  scale_y_continuous(limits=c(0, 100),
                     breaks=c(0, 25, 50, 75, 100),
                     labels=c("0%", "25%", "50%", "75%", "100%")) +
  scale_fill_gradientn(name = expression(paste("% Infective (i)")),
                       limits = c(0, 100),
                       values = c(0.0, 0.05, 0.1, 0.2, 0.3, 0.5, 0.7, 1.0),
                       colours = c("red", "yellow", "green", "blue"),
                       labels = c("0%", "25%", "50%", "75%", "100%")) +
  theme(axis.title.x = element_text(colour='black', size=12, face='bold',
                                    margin=margin(t=0.2, unit = "cm")),
        axis.title.y = element_text(colour='black', size=12, face='bold',
                                    margin=margin(r=0.2, unit = "cm")),
        axis.text.x = element_text(colour='black', size=12, face='bold'),
        axis.text.y = element_text(colour='black', size=12, face='bold'),
        axis.line = element_line(colour='black', size=1, linetype='solid'),
        panel.background = element_rect(fill="transparent", colour=NA),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin = unit(c(1, 0, 0, 0), "cm"),
        legend.position = "none",
        legend.title = element_text(colour="black", size=14, face="bold"),
        legend.text = element_text(colour="black", size=12, face="bold"),
        legend.key = element_rect(fill = "white"))

pf1 <- pf1 + annotation_custom(
  grob = textGrob(label = "A", hjust = 0,
                  gp = gpar(cex = 1.3, fontface="bold")),
  ymin = 115,
  ymax = 115,
  xmin = -118,
  xmax = -118)

gtf1 <- ggplot_gtable(ggplot_build(pf1))
gtf1$layout$clip[gtf1$layout$name == "panel"] <- "off"


filename <- "fluavian-k1.5"
data <- data.table(read.table(paste0(inputFluavianDir, filename,".csv"),
                              sep=";", header=TRUE))

maxh <- 365
pData <- data[which((h <= maxh))]

pf2 <- ggplot(pData[which((n == 0) & (i < 1))],
              aes(x=h, y=(1 - rho) * 100, fill=(i * 100))) +
  xlab("") +
  ylab("") +
  xlim(0, maxh + 60) +
  geom_raster(interpolate=TRUE, stat="identity") +
  geom_contour(data=pData[which(n == 2)],
               aes(x=h, y=(1 - rho) * 100, z=pI),
               breaks=c(0.3, 0.5, 0.7, 0.9),
               color="black",
               linetype="solid",
               size=0.5) +
  geom_line(data=pData[which(n == 2)],
            alpha=0.05,
            size=1) +
  annotate("text", x=190, y=65, label="kappa == 1.5", fontface="bold", size=7, parse=TRUE) +
  scale_y_continuous(limits=c(0, 100),
                     breaks=c(0, 25, 50, 75, 100),
                     labels=c("0%", "25%", "50%", "75%", "100%")) +
  scale_fill_gradientn(name = expression(paste("% Infective (i)")),
                       limits = c(0, 100),
                       values = c(0.0, 0.05, 0.1, 0.2, 0.3, 0.5, 0.7, 1.0),
                       colours = c("red", "yellow", "green", "blue"),
                       labels = c("0%", "25%", "50%", "75%", "100%")) +
  theme(axis.title.x = element_text(colour='black', size=12, face='bold',
                                    margin=margin(t=0.2, unit = "cm")),
        axis.title.y = element_text(colour='black', size=12, face='bold',
                                    margin=margin(r=0.2, unit = "cm")),
        axis.text.x = element_text(colour='black', size=12, face='bold'),
        axis.text.y = element_text(colour='black', size=12, face='bold'),
        axis.line = element_line(colour='black', size=1, linetype='solid'),
        panel.background = element_rect(fill="transparent", colour=NA),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin = unit(c(1, 0, 0, 0), "cm"),
        #legend.position = "none",
        legend.title = element_text(colour="black", size=12, face="bold"),
        legend.text = element_text(colour="black", size=10, face="bold"),
        legend.key = element_rect(fill = "white"))

pf2 <- pf2 + annotation_custom(
  grob = textGrob(label = "B", hjust = 0,
                  gp = gpar(cex = 1.3, fontface="bold")),
  ymin = 115,
  ymax = 115,
  xmin = -118,
  xmax = -118)

gtf2 <- ggplot_gtable(ggplot_build(pf2))
gtf2$layout$clip[gtf2$layout$name == "panel"] <- "off"

gtf <- grid.arrange(gtf1, gtf2, ncol=2, nrow=1,
                    layout_matrix= rbind(c(1, 2)),
                    heights=c(1), widths=c(0.75, 1),
                    bottom=textGrob(expression(paste("Planning Horizon (H)")),
                                    gp=gpar(fontsize=12,
                                            fontface="bold")))

rho <- 0.1
h <- 30
delta <- 0.01
kappa <- 1
iswitch <- calc_iswitch(h, bs, rho, g, lambda, kappa, payoffs)
pars <- list(R0, duration, gamma, betaS, delta, iswitch)
out <- as.data.frame(lsoda(yinit, times, SPIRmodel, pars, rtol=1e-3, atol=1e-3))
data <- data.table(K=kappa, time=out$time, S=out$S, P=out$P, I=out$I, R=out$R)
isp <- data.table(i=iswitch[iswitch[,8] != 1,8])

h <- 30
delta <- 0.1
kappa <- 1.2
iswitch <- calc_iswitch(h, bs, rho, g, lambda, kappa, payoffs)
pars <- list(R0, duration, gamma, betaS, delta, iswitch)
out <- as.data.frame(lsoda(yinit, times, SPIRmodel, pars, rtol=1e-3, atol=1e-3))
data <- rbind(data, data.table(K=kappa, time=out$time, S=out$S, P=out$P, I=out$I, R=out$R))
isp <- rbind(isp, data.table(i=iswitch[iswitch[,8] != 1,8]))

h <- 30
delta <- 0.1
kappa <- 1.5
iswitch <- calc_iswitch(h, bs, rho, g, lambda, kappa, payoffs)
pars <- list(R0, duration, gamma, betaS, delta, iswitch)
out <- as.data.frame(lsoda(yinit, times, SPIRmodel, pars, rtol=1e-3, atol=1e-3))
data <- rbind(data, data.table(K=kappa, time=out$time, S=out$S, P=out$P, I=out$I, R=out$R))
isp <- rbind(isp, data.table(i=iswitch[iswitch[,8] != 1,8]))


pl <- ggplot(data, aes(x=time, y=((I / (S+P+I+R)) * 100),
                       colour=as.factor(K),
                       size=as.factor(K))) +
  xlab(expression(paste("Time (t)"))) +
  ylab(expression(paste("% Infective (i)"))) +
  geom_line() +
  scale_colour_manual(name=expression(paste("Distorted\nPerception (",kappa,")")),
                      values=c("grey60", "blue", "red"),
                      labels=c("1.0", "1.2", "1.5")) +
  scale_size_manual(name=expression(paste("Distorted\nPerception (",kappa,")")),
                    values=c(3, 1.5, 0.75),
                    labels=c("1.0", "1.2", "1.5")) +
  scale_y_continuous(limits=c(0, 17),
                     breaks=c(0, 5, 10, 15),
                     labels=c("0%", "5%", "10%", "15%")) +
  guides(colour = guide_legend(override.aes = list(size=1))) +
  theme(axis.title.x = element_text(colour='black', size=12, face='bold',
                                    margin=margin(t=0.2, unit = "cm")),
        axis.title.y = element_text(colour='black', size=12, face='bold',
                                    margin=margin(r=0.2, unit = "cm")),
        axis.text.x = element_text(colour='black', size=10, face='bold'),
        axis.text.y = element_text(colour='black', size=10, face='bold'),
        axis.line = element_line(colour='black', size=1, linetype='solid'),
        panel.background = element_rect(fill="transparent", colour=NA),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        plot.margin = unit(c(1, 0, 1, 0), "cm"),
        #legend.position = "none",
        legend.title = element_text(colour="black", size=12, face="bold"),
        legend.text = element_text(colour="black", size=10, face="bold"),
        legend.key = element_rect(fill = "white"))

if(nrow(isp) > 0){
  pl <- pl + geom_hline(data=isp, aes(yintercept=i*100),
                        linetype="dashed", color=c("grey60", "blue", "red"), size=c(1,1,1))
}

pl <- pl + annotation_custom(
  grob = textGrob(label = "C", hjust = 0,
                  gp = gpar(cex = 1.3, fontface="bold")),
  ymin = 19,
  ymax = 19,
  xmin = -31,
  xmax = -31)

gt <- ggplot_gtable(ggplot_build(pl))
gt$layout$clip[gt$layout$name == "panel"] <- "off"

plot <- grid.arrange(gtf, gt, ncol=1, nrow=2,
                    layout_matrix= rbind(c(1),c(2)),
                    heights=c(1,1), widths=c(1))

ggsave(paste0(outputDir,"fluavian-fear.pdf"), plot=plot)
